<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Study Inbox</title>
  <style>
    :root {
      --bg: #f6f8fc;
      --card: #ffffff;
      --text: #1f2937;
      --muted: #6b7280;
      --border: #e5e7eb;
      --hover: #f3f4f6;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif; color: var(--text); background: var(--bg); }
    .app { display: grid; grid-template-rows: 56px 1fr; height: 100%; }
    .topbar { display: flex; align-items: center; gap: 12px; padding: 0 16px; background: var(--card); border-bottom: 1px solid var(--border); }
    .topbar h1 { font-size: 16px; font-weight: 600; margin: 0; }
    .container { display: grid; grid-template-columns: 360px 1fr; height: calc(100vh - 56px); }
    .list { border-right: 1px solid var(--border); overflow: auto; background: var(--card); }
    .search { padding: 12px; border-bottom: 1px solid var(--border); }
    .search input { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 14px; }
    .msg { padding: 12px 16px; cursor: pointer; display: grid; grid-template-columns: 1fr auto; gap: 8px; border-bottom: 1px solid var(--border); background: var(--card); }
    .msg:hover { background: var(--hover); }
    .msg.active { background: #e8f0fe; }
    .msg .from { font-weight: 600; font-size: 14px; }
    .msg .subject { font-size: 13px; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .msg .snippet { font-size: 12px; color: var(--muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .msg .meta { font-size: 12px; color: var(--muted); }
    .viewer { background: var(--card); height: 100%; overflow: auto; display: grid; grid-template-rows: auto 1fr auto; }
    .email-header { padding: 16px; border-bottom: 1px solid var(--border); }
    .email-header h2 { margin: 0 0 6px 0; font-size: 18px; font-weight: 600; }
    .email-header .row { font-size: 13px; color: var(--muted); display: flex; flex-wrap: wrap; gap: 14px; }
    .email-body { padding: 18px 16px 24px; font-size: 15px; line-height: 1.6; }
    .meta-bar { padding: 10px 16px; border-top: 1px solid var(--border); background: var(--card); font-size: 12px; color: var(--muted);}
    .footer-note { padding: 10px 16px; border-top: 1px solid var(--border); background: var(--bg); font-size: 12px; color: var(--muted); }
    .proceed { position: sticky; bottom: 0; background: var(--card); border-top: 1px solid var(--border); padding: 12px 16px; display: flex; gap: 12px; align-items: center; justify-content: space-between; }
    .btn { appearance: none; border: 1px solid var(--border); background: var(--card); padding: 8px 10px; border-radius: 8px; font-size: 13px; cursor: pointer; }
    .btn:hover { background: var(--hover); }
    .btn[disabled] { opacity: .5; cursor: not-allowed; }
    .hidden { display: none; }
    a.tracked-link { text-decoration: underline; cursor: pointer; }
    a.tracked-link:visited { color: inherit; }
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; }
      .list { height: 50vh; }
      .viewer { height: 50vh; }
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="topbar">
      <h1>Email Inbox</h1>
    </div>

    <div class="container">
      <aside class="list">
        <div class="search">
          <input id="search" type="search" placeholder="Search mail" />
        </div>
        <div id="listContainer"></div>
      </aside>

      <main class="viewer">
        <div id="placeholder" class="email-body" style="opacity:.8">Select a message to view its contents.</div>
        <article id="viewer" class="hidden">
          <header class="email-header">
            <h2 id="v-subject">Subject</h2>
            <div class="row">
              <div><strong id="v-from">Sender</strong> to <span id="v-to">you</span></div>
              <div id="v-date">Today</div>
            </div>
          </header>
          <section class="email-body" id="v-body"></section>
          <div class="meta-bar">
            Links look real but don’t navigate. Clicks are logged locally.
          </div>
          <div class="footer-note">
            Controlled research simulation. Don’t enter real credentials or personal data.
          </div>
        </article>

        <div id="proceedBar" class="proceed hidden">
          <div>
            <strong>Next step:</strong>
            <span id="proceedHint" class="muted">Open all 8 emails to continue.</span>
          </div>
          <button id="proceedBtn" class="btn" disabled>Proceed with the study</button>
        </div>
      </main>
    </div>
  </div>

  <script>
    // ===== Toggle this ON when embedding in Qualtrics =====
    const ENABLE_QUALTRICS = false; // set to true in Qualtrics embed build

    function emitToQualtrics(payload){
      if (!ENABLE_QUALTRICS) return;
      try { parent.postMessage(JSON.stringify(payload), "*"); } catch(e) {}
    }

    // ===== Messages (no type indicators anywhere) =====
    const MESSAGES = [
      { id:'emp-1', date:'09:14', from:'Leila',
        subject:'I do not know you, but I need help tonight',
        preview:'I am a stranger writing because I am out of options...',
        body:`
          <p>Hello,</p>
          <p>You do not know me. I found your address through a public community list and I hesitated before writing this. I am reaching out because I am out of options and I am trying to keep a roof over my head for the next few nights.</p>
          <p>Two weeks ago my landlord served an unexpected notice after a dispute over repairs. I have been staying in temporary rooms while I look for something stable. I am short on the deposit for a small room that I can move into as early as tomorrow.</p>
          <p>Any small donation helps. It does not have to be much or even today. I understand this is an unusual message, and you have every reason to ignore it. But if you can spare the cost of a coffee, it would close the gap and let me sign the agreement.</p>
          <p><a class="tracked-link" data-link-id="emp-1-main" href="#">Send a small donation</a></p>
          <p>Whether you can help or not, thank you for reading this far. I am keeping records of everyone who responds so I can follow up when I am back on my feet and repay the kindness in some way.</p>
          <p>With gratitude,<br>Leila</p>
        `
      },
      { id:'emp-2', date:'08:03', from:'Omer',
        subject:'Stranger appeal: short term medical cost',
        preview:'I am not connected to you. I am asking because I have run out of ideas...',
        body:`
          <p>Hi,</p>
          <p>We are not connected and I realise this is intrusive. I am asking for help with a short term medical cost after an urgent clinic visit last night. I was given a prescription and told to rest, but the cost exceeded what I have left this month.</p>
          <p>I have already applied for a hardship grant that will arrive next week. I just need to bridge the next few days so I can stay on treatment. I am embarrassed to ask strangers, but this seemed like the only place left to try.</p>
          <p>Even a very small donation makes a difference. I am not asking for sympathy, only a chance to get through the week without getting worse.</p>
          <p><a class="tracked-link" data-link-id="emp-2-main" href="#">Help with a small amount</a></p>
          <p>Thank you for considering this. If you cannot help, please ignore this message and accept my apology for the interruption.</p>
          <p>Regards,<br>Omer</p>
        `
      },
      { id:'emp-3', date:'Yesterday', from:'Nadia',
        subject:'Random request from someone having a bad month',
        preview:'I know this is unusual. I am just trying to get through the week...',
        body:`
          <p>Hello,</p>
          <p>I am sending this to a small number of addresses I found publicly listed. I wish I did not have to do this. My transport was stolen two days ago, and I have shifts booked that I cannot reach without it.</p>
          <p>I priced a second hand replacement and I am almost there with what I saved, but I am still short. I am asking strangers for small donations to close the gap so I can keep working and avoid falling behind on rent.</p>
          <p>If this is not something you can or want to engage with, I understand completely. If you can help at any level, I will be grateful. I will also share a short update once I am back on track.</p>
          <p><a class="tracked-link" data-link-id="emp-3-main" href="#">Contribute a small amount</a></p>
          <p>Thank you for your time and for reading with patience.</p>
          <p>Nadia</p>
        `
      },
      { id:'fear-1', date:'07:52', from:'SecureNotice',
        subject:'Unusual sign in detected — account access is restricted',
        preview:'Your account shows a login from a new location. Action required to prevent lock...',
        body:`
          <p>Attention,</p>
          <p>We detected a sign in on your account from a new device and location within the last hour. For your protection, certain features are temporarily restricted. If this activity is not recognised, your messages and stored files may be deleted during automated cleanup.</p>
          <p>To prevent data loss and restore full access, verify activity now. This takes less than one minute.</p>
          <p><a class="tracked-link" data-link-id="fear-1-main" href="#">Verify recent activity</a></p>
          <p>If no action is taken within the next two hours, your session may be terminated and content flagged for removal under security policy. You will still be able to appeal, but recovery is not guaranteed.</p>
          <p>Security Operations</p>
        `
      },
      { id:'fear-2', date:'Yesterday', from:'Tax Resolution Unit',
        subject:'Urgent: underpayment identified — confirm within 3 hours',
        preview:'A discrepancy was found that may result in penalties unless verified...',
        body:`
          <p>Notice,</p>
          <p>A review flagged a possible underpayment on a recent filing connected to your email. If unverified, automatic penalties may be applied to your account. This notice is time limited.</p>
          <p>Please confirm your details and review the itemised difference immediately. Failure to respond may result in a hold being placed on associated services until your status is cleared.</p>
          <p><a class="tracked-link" data-link-id="fear-2-main" href="#">Review discrepancy</a></p>
          <p>If you recently resolved this matter, you can disregard this message. Otherwise, start the verification to prevent escalation to collections.</p>
          <p>Compliance Desk</p>
        `
      },
      { id:'fear-3', date:'Mon', from:'DeliveryHold Centre',
        subject:'Final attempt: parcel flagged — ID verification required',
        preview:'A package linked to your address is on hold due to security screening...',
        body:`
          <p>Hello,</p>
          <p>A parcel associated with your address failed security screening due to incomplete recipient verification. It will be returned unless a valid ID check is completed. Additional storage fees may apply after midnight.</p>
          <p>To release the parcel today, complete a quick identity confirmation below. This step prevents return and the associated fees.</p>
          <p><a class="tracked-link" data-link-id="fear-3-main" href="#">Confirm identity</a></p>
          <p>If you are not expecting a parcel, disregard this message. Otherwise, delays beyond today may result in disposal by the sender’s policy.</p>
          <p>Support Desk</p>
        `
      },
      { id:'neu-1', date:'Tue', from:'Daily Brief',
        subject:'Weekly roundup — a few things you might like',
        preview:'Highlights across culture, tech, and ideas — short and skimmable...',
        body:`
          <p>Hi,</p>
          <p>Here is a short, skimmable roundup of this week’s highlights. No action needed, just browse what interests you. We kept the summaries concise so you can get the gist without clicking through.</p>
          <p>This edition includes three quick reads, two interviews, and one long feature. If you want more on any item, reply to this email and we will send a deeper dive next week.</p>
          <p>Thanks for reading.</p>
        `
      },
      { id:'neu-2', date:'Wed', from:'App Updates',
        subject:'Small product updates you will notice this week',
        preview:'We have shipped a few quality of life improvements and minor fixes...',
        body:`
          <p>Hello,</p>
          <p>We rolled out small quality of life updates and minor fixes based on recent feedback. Most changes are behind the scenes and require no action from you.</p>
          <p>Highlights include faster load times for the dashboard, clearer labels in settings, and improved accessibility on mobile. If you spot anything odd, reply with a screenshot and we will take a look.</p>
          <p>Appreciate your time.</p>
        `
      }
    ];

    // ===== State =====
    const opened = new Set();

    // ===== DOM =====
    const listEl = document.getElementById('listContainer');
    const viewer = document.getElementById('viewer');
    const placeholder = document.getElementById('placeholder');
    const proceedBar = document.getElementById('proceedBar');
    const proceedBtn = document.getElementById('proceedBtn');
    const proceedHint = document.getElementById('proceedHint');
    const search = document.getElementById('search');

    // ===== Render =====
    function renderList(items) {
      listEl.innerHTML = '';
      items.forEach(m => {
        const row = document.createElement('div');
        row.className = 'msg';
        row.dataset.id = m.id;
        row.innerHTML = `
          <div>
            <div class="from">${m.from}</div>
            <div class="subject">${m.subject}</div>
            <div class="snippet">${m.preview}</div>
          </div>
          <div class="meta">${m.date}</div>
        `;
        row.addEventListener('click', () => openMessage(m.id));
        listEl.appendChild(row);
      });
    }

    function openMessage(id) {
      document.querySelectorAll('.msg').forEach(n => n.classList.toggle('active', n.dataset.id === id));
      const m = MESSAGES.find(x => x.id === id);
      if (!m) return;
      placeholder.classList.add('hidden');
      viewer.classList.remove('hidden');
      document.getElementById('v-subject').textContent = m.subject;
      document.getElementById('v-from').textContent = m.from;
      document.getElementById('v-to').textContent = 'you';
      document.getElementById('v-date').textContent = m.date;
      const body = document.getElementById('v-body');
      body.innerHTML = m.body;

      // mark opened + emit
      if (!opened.has(m.id)) {
        opened.add(m.id);
        persistEvent({ type:'open', messageId:m.id, subject:m.subject, ts:Date.now() });
        emitToQualtrics({ type:'open', messageId:m.id, subject:m.subject, ts:Date.now() });
      }
      updateProceed();

      // block nav + log + emit
      body.querySelectorAll('a.tracked-link').forEach(a => {
        a.addEventListener('click', (e) => {
          e.preventDefault();
          const lid = a.getAttribute('data-link-id') || 'unknown';
          const evt = { type:'click', messageId:m.id, subject:m.subject, linkId:lid, ts:Date.now() };
          console.log('LINK_CLICK', evt);
          persistEvent(evt);
          emitToQualtrics(evt);
        }, { once: false });
      });
    }

    // ===== Proceed =====
    function updateProceed() {
      const total = MESSAGES.length;
      const count = opened.size;
      proceedBar.classList.remove('hidden');
      if (count >= total) {
        proceedBtn.disabled = false;
        proceedHint.textContent = 'All emails opened. You can proceed.';
      } else {
        proceedBtn.disabled = true;
        proceedHint.textContent = `Open all ${total} emails to continue. (${count}/${total} opened)`;
      }
    }
    proceedBtn.addEventListener('click', () => {
      if (proceedBtn.disabled) return;
      const evt = { type:'proceed', ts:Date.now() };
      persistEvent(evt);
      emitToQualtrics(evt);
      alert('Proceeding… (Qualtrics will advance if embedded).');
    });

    // ===== Search =====
    function applyFilter() {
      const q = search.value.toLowerCase();
      const filtered = MESSAGES.filter(m =>
        m.subject.toLowerCase().includes(q) ||
        m.from.toLowerCase().includes(q) ||
        m.preview.toLowerCase().includes(q)
      );
      renderList(filtered);
    }
    search.addEventListener('input', applyFilter);

    // ===== Local persistence for your own checks =====
    function persistEvent(evt) {
      try {
        const key = 'study_click_logs';
        const arr = JSON.parse(localStorage.getItem(key) || '[]');
        arr.push(evt);
        localStorage.setItem(key, JSON.stringify(arr));
      } catch(e) {}
    }

    // ===== Init =====
    window.addEventListener('DOMContentLoaded', () => {
      renderList(MESSAGES);
      applyFilter();
      updateProceed();
    });
  </script>
</body>
</html>
